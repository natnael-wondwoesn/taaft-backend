<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAAFT Chat Interface</title>
    <!-- Add tool recommendations script -->
    <script src="/static/js/tool_recommendations.js" defer></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --background-color: #f5f7fa;
            --dark-bg: #2c3e50;
            --light-text: #ecf0f1;
            --dark-text: #34495e;
            --success: #2ecc71;
            --warning: #f39c12;
            --info: #3498db;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--dark-text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background-color: var(--dark-bg);
            color: var(--light-text);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            box-shadow: var(--box-shadow);
        }

        header h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        main {
            display: flex;
            flex: 1;
            gap: 1rem;
            min-height: 0;
        }

        .sidebar {
            width: 300px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .chat-session {
            padding: 0.75rem;
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .chat-session:hover {
            background-color: #e0e6ed;
        }

        .chat-session.active {
            background-color: var(--primary-color);
            color: white;
        }

        .new-chat-btn {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .new-chat-btn:hover {
            background-color: #27ae60;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .chat-header {
            padding: 1rem;
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header select {
            background-color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 14px;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 80%;
            padding: 1rem;
            border-radius: var(--border-radius);
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 0;
        }

        .message.assistant {
            align-self: flex-start;
            background-color: var(--background-color);
            border-bottom-left-radius: 0;
        }

        .message.system {
            align-self: center;
            background-color: var(--warning);
            color: white;
            font-size: 14px;
            max-width: 90%;
            text-align: center;
        }

        .message-form {
            display: flex;
            padding: 1rem;
            gap: 1rem;
            border-top: 1px solid #e0e6ed;
        }

        .message-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #e0e6ed;
            border-radius: var(--border-radius);
            resize: none;
            font-size: 16px;
            min-height: 60px;
            max-height: 150px;
            overflow-y: auto;
        }

        .message-input:focus {
            outline: 2px solid var(--primary-color);
            border-color: transparent;
        }

        .send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .send-btn:hover {
            background-color: var(--secondary-color);
        }

        .send-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .system-prompt-container {
            margin-top: 1rem;
        }

        .system-prompt-container label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .system-prompt {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e0e6ed;
            border-radius: var(--border-radius);
            resize: none;
            font-size: 14px;
            height: 80px;
        }

        .system-prompt:focus {
            outline: 2px solid var(--primary-color);
            border-color: transparent;
        }

        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            background-color: var(--dark-bg);
            color: white;
            box-shadow: var(--box-shadow);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .status.show {
            opacity: 1;
            transform: translateY(0);
        }

        .status.error {
            background-color: var(--accent-color);
        }

        .status.success {
            background-color: var(--success);
        }

        .typing-indicator {
            display: inline-block;
            font-size: 20px;
            padding: 10px;
        }

        .typing-indicator span {
            display: inline-block;
            width: 7px;
            height: 7px;
            background-color: var(--primary-color);
            border-radius: 50%;
            margin: 0 2px;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        /* Responsive styles */
        @media (max-width: 900px) {
            main {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                max-height: 200px;
            }
            .chat-container {
                height: 50vh;
            }
        }

        /* Add CSS for auth container and forms */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-forms {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            width: 350px;
            box-shadow: var(--box-shadow);
        }

        .auth-form h2 {
            margin-bottom: 1.5rem;
            color: var(--dark-text);
            text-align: center;
        }

        .auth-form input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #e0e6ed;
            border-radius: var(--border-radius);
            font-size: 16px;
        }

        .auth-form input:focus {
            outline: 2px solid var(--primary-color);
            border-color: transparent;
        }

        .auth-form button {
            width: 100%;
            padding: 0.75rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .auth-form button:hover {
            background-color: var(--secondary-color);
        }

        .auth-form p {
            text-align: center;
            font-size: 14px;
        }

        .auth-form a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .auth-form a:hover {
            text-decoration: underline;
        }

        .auth-error {
            color: var(--accent-color);
            font-size: 14px;
            margin-bottom: 1rem;
            text-align: center;
        }

        /* Hide auth container by default */
        #auth-container {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M8 12H16" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 16V8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                TAAFT Chat Interface
            </h1>
        </header>
        <main>
            <div class="sidebar">
                <button class="new-chat-btn" id="new-chat-btn">New Chat</button>
                <div class="chat-list" id="chat-list">
                    <!-- Chat sessions will be loaded here -->
                </div>
            </div>
            <div class="chat-container">
                <div class="chat-header">
                    <span id="chat-title">New Chat</span>
                    <select id="model-select">
                        <option value="default">Default Model</option>
                        <option value="gpt4">GPT-4</option>
                        <option value="claude">Claude</option>
                        <option value="llama">Llama</option>
                    </select>
                </div>
                <div class="messages" id="messages">
                    <!-- Messages will be displayed here -->
                </div>
                <div class="message-form">
                    <textarea class="message-input" id="message-input" placeholder="Type your message here..."></textarea>
                    <button class="send-btn" id="send-btn">Send</button>
                </div>
            </div>
        </main>
        <div class="status" id="status">Status message</div>
    </div>

    <div class="auth-container" id="auth-container">
        <div class="auth-forms">
            <div id="sign-in-form" class="auth-form">
                <h2>Sign In</h2>
                <div id="sign-in-error" class="auth-error"></div>
                <input type="email" id="sign-in-email" placeholder="Email" required>
                <input type="password" id="sign-in-password" placeholder="Password" required>
                <button id="sign-in-btn">Sign In</button>
                <p>Don't have an account? <a href="#" id="show-sign-up">Sign Up</a></p>
            </div>
            <div id="sign-up-form" class="auth-form" style="display: none;">
                <h2>Sign Up</h2>
                <div id="sign-up-error" class="auth-error"></div>
                <input type="email" id="sign-up-email" placeholder="Email" required>
                <input type="password" id="sign-up-password" placeholder="Password" required>
                <input type="password" id="sign-up-confirm-password" placeholder="Confirm Password" required>
                <button id="sign-up-btn">Sign Up</button>
                <p>Already have an account? <a href="#" id="show-sign-in">Sign In</a></p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://taaft-backend.onrender.com/api/chat';
        console.log(API_URL);
        const WS_URL = `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`;
        let currentChatId = null;
        let userId = null; // Will be populated from token
        let socket = null;
        let isConnected = false;
        let messageQueue = [];
        
        // Add headers to requests with authentication token if available
        function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (accessToken) {
                headers['Authorization'] = `Bearer ${accessToken}`;
            }
            
            return headers;
        }
        
        // Initialize the application
        function init() {
            if (accessToken) {
                userId = getUserIdFromToken(accessToken);
            } else {
                userId = 'testuser-' + Math.floor(Math.random() * 10000); // Fallback anonymous ID
            }
            
            initWebSocket();
            
            if (isAuthenticated) {
                loadUserSessions();
            }
        }

        // DOM Elements
        const chatList = document.getElementById('chat-list');
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const modelSelect = document.getElementById('model-select');
        const chatTitle = document.getElementById('chat-title');
        const statusEl = document.getElementById('status');

        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        newChatBtn.addEventListener('click', createNewChat);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize WebSocket connection
        function initWebSocket() {
            if (socket && socket.readyState !== WebSocket.CLOSED) {
                return; // Already connected
            }
            
            socket = new WebSocket(WS_URL);
            console.log("Attempting WebSocket connection to:", WS_URL);
            
            socket.onopen = function(e) {
                console.log("WebSocket connection established");
                isConnected = true;
                showStatus('Connected to server', 'success');
                
                // Send authentication info
                const authData = {
                    type: 'user_connected',
                    user_id: userId,
                    auth_token: accessToken
                };
                console.log("Sending auth data:", authData);
                socket.send(JSON.stringify(authData));
                
                // Process any messages that were queued while disconnected
                if (messageQueue.length > 0) {
                    console.log(`Processing ${messageQueue.length} queued messages`);
                    messageQueue.forEach(msg => socket.send(JSON.stringify(msg)));
                    messageQueue = [];
                }
            };
            
            socket.onmessage = function(event) {
                console.log("WebSocket message received:", event.data);
                try {
                    const data = JSON.parse(event.data);
                    handleSocketMessage(data);
                } catch (error) {
                    console.error("Error parsing WebSocket message:", error);
                    showStatus('Error processing server response', 'error');
                }
            };
            
            socket.onclose = function(event) {
                if (event.wasClean) {
                    console.log(`WebSocket connection closed cleanly, code=${event.code} reason=${event.reason}`);
                } else {
                    // Connection died
                    console.error('WebSocket connection died unexpectedly');
                    showStatus('Connection lost. Reconnecting...', 'error');
                }
                isConnected = false;
                
                // Try to reconnect after a delay
                setTimeout(initWebSocket, 3000);
            };
            
            socket.onerror = function(error) {
                console.error(`WebSocket error:`, error);
                showStatus('WebSocket connection error', 'error');
            };
        }

        // Handle incoming WebSocket messages
        function handleSocketMessage(data) {
            console.log("Processing WebSocket message:", data);
            
            // Handle different message types
            if (data.type === 'chat_response') {
                // Response from streaming LLM
                const currentResponseEl = document.getElementById('current-response');
                if (currentResponseEl) {
                    currentResponseEl.textContent = data.content;
                    scrollToBottom();
                    
                    // If the response is complete, update the ID
                    if (data.status === 'complete') {
                        console.log("LLM stream complete");
                        currentResponseEl.id = 'response-' + data.message_id;
                    }
                } else {
                    console.warn("No response element found for chat response");
                    // Create a new element if needed
                    const responseEl = document.createElement('div');
                    responseEl.className = 'message assistant';
                    responseEl.textContent = data.content;
                    if (data.status === 'complete') {
                        responseEl.id = 'response-' + data.message_id;
                    } else {
                        responseEl.id = 'current-response';
                    }
                    messagesContainer.appendChild(responseEl);
                }
            }
            // Old message format - legacy support
            else if (data.type === 'llm_chunk') {
                console.log("Received legacy llm_chunk");
                const currentResponseEl = document.getElementById('current-response');
                if (currentResponseEl) {
                    currentResponseEl.textContent += data.content;
                    scrollToBottom();
                }
            } 
            // Stream complete message - legacy support
            else if (data.type === 'stream_end') {
                console.log("Received legacy stream_end");
                const currentResponseEl = document.getElementById('current-response');
                if (currentResponseEl) {
                    currentResponseEl.id = 'response-' + data.message_id;
                    removeTypingIndicator();
                    scrollToBottom();
                }
            } 
            // Connected confirmation
            else if (data.type === 'connected') {
                console.log("Connection confirmed by server:", data);
                showStatus('Connected to server', 'success');
            }
            // Error message
            else if (data.type === 'error') {
                console.error("WebSocket error from server:", data.message);
                removeTypingIndicator();
                
                // Remove the current response element if there's an error
                const currentResponseEl = document.getElementById('current-response');
                if (currentResponseEl) {
                    currentResponseEl.remove();
                }
                
                addMessageToUI('system', `Error: ${data.message}`);
                showStatus('Error: ' + data.message, 'error');
            }
            // General broadcast message
            else if (data.type === 'broadcast') {
                console.log('Broadcast message:', data.message);
            }
            // Unknown message type
            else {
                console.warn('Unknown message type received:', data.type);
            }
        }

        // Functions
        async function loadUserSessions() {
            try {
                const response = await fetch(`${API_URL}/sessions?user_id=${userId}`, {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    const sessions = await response.json();
                    renderChatSessions(sessions);
                    
                    // If there are sessions, load the most recent one
                    if (sessions.length > 0) {
                        loadChatSession(sessions[0]._id);
                    }
                } else if (response.status === 401) {
                    // Token expired, try to refresh
                    const refreshed = await refreshAccessToken();
                    if (refreshed) {
                        loadUserSessions();
                    } else {
                        handleLogout();
                    }
                } else {
                    showStatus('Failed to load chat sessions', 'error');
                }
            } catch (error) {
                console.error('Error loading chat sessions:', error);
                showStatus('Error connecting to the server', 'error');
            }
        }

        function renderChatSessions(sessions) {
            chatList.innerHTML = '';
            sessions.forEach(session => {
                const sessionEl = document.createElement('div');
                sessionEl.className = 'chat-session';
                sessionEl.textContent = session.title || 'Untitled Chat';
                sessionEl.dataset.id = session._id;
                
                sessionEl.addEventListener('click', () => {
                    loadChatSession(session._id);
                    document.querySelectorAll('.chat-session').forEach(el => {
                        el.classList.remove('active');
                    });
                    sessionEl.classList.add('active');
                });
                
                chatList.appendChild(sessionEl);
            });
        }

        async function loadChatSession(sessionId) {
            try {
                // Get session details
                const sessionResponse = await fetch(`${API_URL}/sessions/${sessionId}`, {
                    headers: getAuthHeaders()
                });
                
                if (!sessionResponse.ok) {
                    if (sessionResponse.status === 401) {
                        // Token expired, try to refresh
                        const refreshed = await refreshAccessToken();
                        if (refreshed) {
                            loadChatSession(sessionId);
                            return;
                        } else {
                            handleLogout();
                            throw new Error('Authentication failed');
                        }
                    }
                    throw new Error('Failed to load session');
                }
                
                const session = await sessionResponse.json();
                currentChatId = session._id;
                chatTitle.textContent = session.title;
                modelSelect.value = session.model;
                
                // Get messages
                const messagesResponse = await fetch(`${API_URL}/sessions/${sessionId}/messages`, {
                    headers: getAuthHeaders()
                });
                
                if (!messagesResponse.ok) {
                    if (messagesResponse.status === 401) {
                        // Token expired, try to refresh
                        const refreshed = await refreshAccessToken();
                        if (refreshed) {
                            loadChatSession(sessionId);
                            return;
                        } else {
                            handleLogout();
                            throw new Error('Authentication failed');
                        }
                    }
                    throw new Error('Failed to load messages');
                }
                
                const messages = await messagesResponse.json();
                renderMessages(messages);
                
                // Highlight the active session in the sidebar
                document.querySelectorAll('.chat-session').forEach(el => {
                    el.classList.toggle('active', el.dataset.id === sessionId);
                });
                
                showStatus('Chat loaded', 'success');
            } catch (error) {
                console.error('Error loading chat session:', error);
                showStatus('Error loading chat session: ' + error.message, 'error');
            }
        }

        async function createNewChat() {
            try {
                const response = await fetch(`${API_URL}/sessions`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        title: 'New Chat',
                        user_id: userId,
                        model: modelSelect.value,
                    }),
                });
                
                if (response.ok) {
                    const session = await response.json();
                    currentChatId = session._id;
                    chatTitle.textContent = session.title;
                    messagesContainer.innerHTML = '';
                    
                    // Add the new session to the sidebar
                    const sessionEl = document.createElement('div');
                    sessionEl.className = 'chat-session active';
                    sessionEl.textContent = session.title;
                    sessionEl.dataset.id = session._id;
                    
                    sessionEl.addEventListener('click', () => {
                        loadChatSession(session._id);
                        document.querySelectorAll('.chat-session').forEach(el => {
                            el.classList.remove('active');
                        });
                        sessionEl.classList.add('active');
                    });
                    
                    chatList.prepend(sessionEl);
                    
                    // Set all other sessions as inactive
                    document.querySelectorAll('.chat-session').forEach(el => {
                        if (el !== sessionEl) {
                            el.classList.remove('active');
                        }
                    });
                    
                    showStatus('New chat created', 'success');
                } else if (response.status === 401) {
                    // Token expired, try to refresh
                    const refreshed = await refreshAccessToken();
                    if (refreshed) {
                        createNewChat();
                    } else {
                        handleLogout();
                        throw new Error('Authentication failed');
                    }
                } else {
                    // Get the error details from the response
                    let errorDetail = 'Failed to create new chat';
                    try {
                        const errorData = await response.json();
                        errorDetail = errorData.detail || errorDetail;
                    } catch (e) {
                        console.error('Error parsing error response:', e);
                    }
                    
                    console.error('Server error:', errorDetail);
                    showStatus(`Error creating new chat: ${errorDetail}`, 'error');
                    throw new Error(errorDetail);
                }
            } catch (error) {
                console.error('Error creating new chat:', error);
                showStatus(`Error creating new chat: ${error.message}`, 'error');
            }
        }

        function renderMessages(messages) {
            messagesContainer.innerHTML = '';
            messages.forEach(message => {
                const isUser = message.role === 'user';
                displayMessage(message.content, isUser);
            });
            scrollToBottom();
        }

        function addMessageToUI(role, content, messageId = null) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${role}`;
            messageEl.textContent = content;
            
            if (messageId) {
                messageEl.id = 'response-' + messageId;
            }
            
            messagesContainer.appendChild(messageEl);
            scrollToBottom();
            return messageEl;
        }

        function startStreamedResponse() {
            // Create a placeholder for the streamed response
            const responseEl = document.createElement('div');
            responseEl.className = 'message assistant';
            responseEl.id = 'current-response';
            responseEl.textContent = ''; // Will be filled by the stream
            messagesContainer.appendChild(responseEl);
            scrollToBottom();
            return responseEl;
        }

        function addTypingIndicator() {
            const indicatorEl = document.createElement('div');
            indicatorEl.className = 'message assistant typing-indicator';
            indicatorEl.id = 'typing-indicator';
            indicatorEl.innerHTML = '<span></span><span></span><span></span>';
            messagesContainer.appendChild(indicatorEl);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            try {
                if (!currentChatId) {
                    await createNewChat();
                }
                
                // Add user message to UI
                const userMessageElement = displayMessage(message, true);
                messageInput.value = '';
                
                // Show typing indicator
                showTypingIndicator();
                
                try {
                    // Prepare the request
                    const requestOptions = {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            message: message,
                            model: modelSelect.value,
                            metadata: userId ? { user_id: userId } : null
                        })
                    };
                    
                    // Send the request via REST API
                    const response = await fetch(`${API_URL}/sessions/${currentChatId}/messages`, requestOptions);
                    
                    // Hide typing indicator
                    hideTypingIndicator();
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Display the assistant's response
                        const messageElement = displayMessage(data.message);
                        
                        // Check if there are tool recommendations to display
                        if (data.tool_recommendations && data.tool_recommendations.length > 0) {
                            displayToolRecommendations(messageElement, data.tool_recommendations);
                        }
                        
                        // Update chat title for new chats
                        if (chatTitle.textContent === 'New Chat') {
                            const newTitle = message.length > 30 ? message.substring(0, 30) + '...' : message;
                            chatTitle.textContent = newTitle;
                            
                            // Also update the title in the sidebar
                            const activeSession = document.querySelector('.chat-session.active');
                            if (activeSession) {
                                activeSession.textContent = newTitle;
                            }
                            
                            // Send title update to the server
                            fetch(`${API_URL}/sessions/${currentChatId}`, {
                                method: 'PUT',
                                headers: getAuthHeaders(),
                                body: JSON.stringify({ title: newTitle }),
                            }).catch(error => console.error('Error updating title:', error));
                        }
                    } else if (response.status === 401) {
                        // Token expired, try to refresh
                        const refreshed = await refreshAccessToken();
                        if (refreshed) {
                            console.log("Token refreshed, retrying message send");
                            sendMessage(); // Try again with new token
                        } else {
                            handleLogout();
                            showStatus('Authentication failed', 'error');
                        }
                    } else {
                        const errorData = await response.json();
                        console.error("REST API error:", errorData);
                        displayMessage(`Error: ${errorData.detail || 'Failed to get response'}`);
                        showStatus('Error getting response', 'error');
                    }
                } catch (error) {
                    hideTypingIndicator();
                    console.error('Error sending message via REST API:', error);
                    displayMessage('Error: Could not connect to the server');
                    showStatus('Error connecting to the server', 'error');
                }
            } catch (error) {
                console.error('Error in sendMessage function:', error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showStatus(message, type = 'info') {
            statusEl.textContent = message;
            statusEl.className = `status ${type} show`;
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 3000);
        }

        // Toggle between sign-in and sign-up forms
        document.getElementById('show-sign-up').addEventListener('click', function(event) {
            event.preventDefault();
            document.getElementById('sign-in-form').style.display = 'none';
            document.getElementById('sign-up-form').style.display = 'block';
        });

        document.getElementById('show-sign-in').addEventListener('click', function(event) {
            event.preventDefault();
            document.getElementById('sign-up-form').style.display = 'none';
            document.getElementById('sign-in-form').style.display = 'block';
        });

        // Auth variables
        const AUTH_API_URL = 'https://taaft-backend.onrender.com/auth';
        let accessToken = localStorage.getItem('access_token');
        let refreshToken = localStorage.getItem('refresh_token');
        let isAuthenticated = !!accessToken;

        // Auth event listeners
        document.getElementById('sign-in-btn').addEventListener('click', handleSignIn);
        document.getElementById('sign-up-btn').addEventListener('click', handleSignUp);

        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
        });

        // Show auth container if not authenticated
        function checkAuthStatus() {
            if (!isAuthenticated) {
                document.getElementById('auth-container').style.display = 'flex';
                document.querySelector('.container').style.display = 'none';
            } else {
                document.getElementById('auth-container').style.display = 'none';
                document.querySelector('.container').style.display = 'flex';
                
                // Get user info if needed
                getUserInfo();
            }
        }

        // Handle sign in
        async function handleSignIn() {
            const email = document.getElementById('sign-in-email').value;
            const password = document.getElementById('sign-in-password').value;
            const errorEl = document.getElementById('sign-in-error');
            
            if (!email || !password) {
                errorEl.textContent = 'Please enter email and password';
                return;
            }

            try {
                const formData = new FormData();
                formData.append('username', email); // OAuth expects username field for email
                formData.append('password', password);

                const response = await fetch(`${AUTH_API_URL}/token`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access_token;
                    refreshToken = data.refresh_token;
                    
                    // Store tokens
                    localStorage.setItem('access_token', accessToken);
                    localStorage.setItem('refresh_token', refreshToken);
                    
                    // Update auth state
                    isAuthenticated = true;
                    
                    // Get real user ID from token instead of random ID
                    userId = getUserIdFromToken(accessToken);
                    
                    // Update UI
                    checkAuthStatus();
                    showStatus('Successfully signed in', 'success');
                    
                    // Initialize WebSocket with real user
                    initWebSocket();
                    
                    // Load user data
                    loadUserSessions();
                } else {
                    const errorData = await response.json();
                    errorEl.textContent = errorData.detail || 'Invalid email or password';
                }
            } catch (error) {
                console.error('Error signing in:', error);
                errorEl.textContent = 'Error connecting to the server';
            }
        }

        // Handle sign up
        async function handleSignUp() {
            const email = document.getElementById('sign-up-email').value;
            const password = document.getElementById('sign-up-password').value;
            const confirmPassword = document.getElementById('sign-up-confirm-password').value;
            const errorEl = document.getElementById('sign-up-error');
            
            if (!email || !password) {
                errorEl.textContent = 'Please enter email and password';
                return;
            }
            
            if (password !== confirmPassword) {
                errorEl.textContent = 'Passwords do not match';
                return;
            }

            try {
                const response = await fetch(`${AUTH_API_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        full_name: '' // Optional field
                    })
                });

                if (response.ok) {
                    // Registration successful, switch to sign-in form
                    document.getElementById('sign-up-form').style.display = 'none';
                    document.getElementById('sign-in-form').style.display = 'block';
                    document.getElementById('sign-in-email').value = email;
                    document.getElementById('sign-in-password').value = '';
                    showStatus('Account created! Please sign in.', 'success');
                } else {
                    const errorData = await response.json();
                    errorEl.textContent = errorData.detail || 'Error creating account';
                }
            } catch (error) {
                console.error('Error signing up:', error);
                errorEl.textContent = 'Error connecting to the server';
            }
        }

        // Parse JWT token to get user ID
        function getUserIdFromToken(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                const payload = JSON.parse(jsonPayload);
                return payload.sub; // This is the user ID
            } catch (error) {
                console.error('Error parsing token:', error);
                return null;
            }
        }

        // Get user information
        async function getUserInfo() {
            if (!accessToken) return;

            try {
                const response = await fetch(`${AUTH_API_URL}/users/me`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    userId = userData.id;
                    console.log('User data loaded:', userData);
                } else if (response.status === 401) {
                    // Token expired, try to refresh
                    const refreshed = await refreshAccessToken();
                    if (refreshed) {
                        getUserInfo();
                    } else {
                        handleLogout();
                    }
                }
            } catch (error) {
                console.error('Error getting user info:', error);
            }
        }

        // Refresh access token using refresh token
        async function refreshAccessToken() {
            if (!refreshToken) return false;

            try {
                const response = await fetch(`${AUTH_API_URL}/refresh-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        refresh_token: refreshToken
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access_token;
                    localStorage.setItem('access_token', accessToken);
                    return true;
                } else {
                    return false;
                }
            } catch (error) {
                console.error('Error refreshing token:', error);
                return false;
            }
        }

        // Handle user logout
        function handleLogout() {
            // Clear tokens
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            accessToken = null;
            refreshToken = null;
            isAuthenticated = false;
            
            // Update UI
            checkAuthStatus();
        }

        // Add logout button to header
        const header = document.querySelector('header h1');
        const logoutButton = document.createElement('button');
        logoutButton.textContent = 'Logout';
        logoutButton.style.marginLeft = 'auto';
        logoutButton.style.padding = '0.5rem 1rem';
        logoutButton.style.backgroundColor = 'var(--accent-color)';
        logoutButton.style.color = 'white';
        logoutButton.style.border = 'none';
        logoutButton.style.borderRadius = 'var(--border-radius)';
        logoutButton.style.cursor = 'pointer';
        logoutButton.addEventListener('click', handleLogout);
        header.appendChild(logoutButton);

        // Start the application
        init();

        // Function to display a message
        function displayMessage(message, isUser = false) {
            const messageElement = document.createElement('div');
            messageElement.className = `message${isUser ? ' user-message' : ''}`;
            
            let messageContent = message;
            if (typeof message === 'object') {
                messageContent = message.content || message.message || JSON.stringify(message);
            }
            
            // Create message content
            const contentElement = document.createElement('div');
            contentElement.className = 'message-content';
            contentElement.innerHTML = formatMessage(messageContent);
            messageElement.appendChild(contentElement);
            
            // Add message to chat container
            chatMessagesContainer.appendChild(messageElement);
            
            // Scroll to bottom
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
            
            return messageElement;
        }

        // Initialize tool recommendations component
        let toolRecommendations = null;
        
        function initToolRecommendations() {
            if (!toolRecommendations) {
                toolRecommendations = new ToolRecommendations();
            }
            return toolRecommendations;
        }
        
        // Format message with markdown support
        function formatMessage(text) {
            if (!text) return '';
            
            // Basic markdown formatting
            // Replace *text* with <strong>text</strong>
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Replace *text* with <em>text</em>
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Replace links with clickable links
            text = text.replace(
                /(https?:\/\/[^\s]+)/g, 
                '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
            );
            
            // Replace newlines with <br>
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }

        // Display tool recommendations if available
        function displayToolRecommendations(messageElement, tools) {
            if (!tools || !tools.length) return;
            
            const recommendations = initToolRecommendations();
            recommendations.render(tools, messageElement, {
                heading: 'Recommended AI Tools',
                moreToolsLink: true,
                onMoreTools: () => {
                    window.location.href = '/tools';
                }
            });
        }

        // Send a message to the API
        async function sendMessage(sessionId, message) {
            if (!message.trim()) return;
            
            // Create the message element
            displayMessage(message, true);
            
            // Clear input field
            messageInput.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Prepare the request
                const requestOptions = {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        ...(accessToken ? { 'Authorization': `Bearer ${accessToken}` } : {})
                    },
                    body: JSON.stringify({
                        message: message,
                        metadata: userId ? { user_id: userId } : null
                    })
                };
                
                // Send the request
                const url = sessionId 
                    ? `${API_BASE_URL}/sessions/${sessionId}/messages`
                    : `${API_BASE_URL}`;
                
                const response = await fetch(url, requestOptions);
                
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                
                // Parse the response
                const data = await response.json();
                
                // If this is a new chat, update the session ID and title
                if (!sessionId) {
                    currentSessionId = data.chat_id;
                    // Update URL with session ID
                    history.pushState(null, '', `?id=${currentSessionId}`);
                    // Update the session list
                    await loadSessions();
                }
                
                // Hide typing indicator
                hideTypingIndicator();
                
                // Display the assistant's response
                const messageElement = displayMessage(data.message);
                
                // Check if there are tool recommendations to display
                if (data.tool_recommendations && data.tool_recommendations.length > 0) {
                    displayToolRecommendations(messageElement, data.tool_recommendations);
                }
                
                return data;
            } catch (error) {
                console.error('Error sending message:', error);
                hideTypingIndicator();
                // Display error message
                displayMessage('Sorry, there was an error sending your message. Please try again.');
                return null;
            }
        }

        // Alias functions for consistency
        const showTypingIndicator = addTypingIndicator;
        const hideTypingIndicator = removeTypingIndicator;
    </script>
</body>
</html> 